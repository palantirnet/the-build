<?xml version="1.0"?>

<!--
  @file configure.xml
  Interactive configuration for the-build.

  Copyright 2016, 2017 Palantir.net, Inc.
  -->

<project name="configure" default="configure">
    <!--
        This can be used to configure the build properties for a project.
      -->


    <fail unless="build.dir" />
    <fail unless="build.env" />


    <!-- Target: configure -->
    <target name="configure-sites" >

        <if>
            <not><isset property="build.sites"></isset></not>
            <then>
                <property name="build.sites" value="default" />
            </then>
        </if>

        <!-- Configure each drupal site. -->
        <foreach list="${build.sites}" target="drupal-configure" param="drupal.sites_subdir" />

    </target>


    <!-- Configure the build environment. -->
    <!--
    Try:
    configure-env -Dbuild.env=vagrant -Dupdate=drupal.root -Ddrupal.root=www ## Updates drupal.root to www
    configure-env -Dbuild.env=vagrant -Dupdate=env.new_setting               ## Adds a new setting
    -->
    <target name="configure-env">
        <fail unless="build.env" />

        <!-- Initialize the environment. -->
        <phingcall target="configure-init-environment" />

        <phingcall target="configure" description="Configure ${build.env} environment." >
            <property name="properties.type" value="env" />
            <property name="properties.name" value="${build.env}" />
        </phingcall>

        <phingcall target="configure-sites" description="Configure Drupal sites." >
            <property name="properties.type" value="site" />
        </phingcall>

    </target>


    <!-- Add/update a configuration file. -->
    <target name="configure">

        <fail unless="properties.type" />
        <fail unless="properties.name" />

        <property name="update" value="" />
        <property name="dump" value="" />

        <!-- Initialize the environment. -->
        <property name="propertiesfile" value="conf/build.${properties.name}.${properties.type}.properties" />
        <phingcall target="configure-init-environment" />

        <!-- Load properties from the file we're editing, with the prefix "default.*" -->
        <property file="${build.dir}/${propertiesfile}" prefix="default" />
        <property file="${build.dir}/conf/build.default.${properties.type}.properties" prefix="default" />

        <!-- Update properties interactively. -->
        <foreach list="${update}" target="configure-update-property" param="propertyname" />

        <!-- Dump other properties without interaction -->
        <foreach list="${dump}" target="configure-update-property-silent" param="propertyname" />
    </target>


    <target name="configure-init-environment">
        <fail unless="build.dir" />

        <!-- Create the conf directory if it doesn't already exist. -->
        <if>
            <not><available file="${build.dir}/conf" /></not>
            <then>
                <mkdir dir="${build.dir}/conf" />
            </then>
        </if>

        <!-- Create the properties file if it doesn't already exist. -->
        <if>
            <and>
                <isset property="propertiesfile" />
                <not><available file="${build.dir}/${propertiesfile}" /></not>
            </and>
            <then>
                <touch file="${build.dir}/${propertiesfile}" />
            </then>
        </if>
    </target>


    <target name="configure-update-property-silent">
        <fail unless="propertyname" />
        <fail unless="propertiesfile" />
        <fail unless="default.${propertyname}" />

        <property name="${propertyname}" value="${default.${propertyname}}" />
        <phingcall target="configure-update-property" />
    </target>


    <target name="configure-update-property">
        <fail unless="build.dir" />
        <fail unless="propertiesfile" />
        <fail unless="propertyname" />

        <property name="prompt.${propertyname}" value="Enter a value for '${propertyname}'" />
        <property name="default.${propertyname}" value="" />

        <!-- Get the new property value from the user. -->
        <propertyprompt propertyName="${propertyname}" defaultValue="${default.${propertyname}}" promptText="${prompt.${propertyname}}" promptCharacter=":" useExistingValue="true" />

        <!-- Load the properties file so we can see if the property is in there yet. -->
        <loadfile property="propertiesfile.contents" file="${build.dir}/${propertiesfile}">
            <filterchain>
                <linecontainsregexp>
                    <regexp pattern="^${propertyname}=" />
                </linecontainsregexp>
            </filterchain>
        </loadfile>

        <!-- If the property isn't set there yet, add a line for it. -->
        <if>
            <not><contains string="${propertiesfile.contents}" substring="${propertyname}=" /></not>
            <then>
                <!-- Whitespace is significant within this echo; adds a newline after the new property. -->
                <echo file="${build.dir}/${propertiesfile}" append="true">${propertyname}=
</echo>
            </then>
        </if>

        <!-- Apply the new setting to the properties file. -->
        <reflexive>
            <fileset dir="${build.dir}" includes="${propertiesfile}" />
            <filterchain>
                <replaceregexp>
                    <regexp pattern="${propertyname}=.*" replace="${propertyname}=${${propertyname}}" />
                </replaceregexp>
            </filterchain>
        </reflexive>
    </target>


</project>
